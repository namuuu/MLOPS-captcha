<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Entraîneur de CAPTCHA IA</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icônes lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50 p-8">

<div class="max-w-6xl mx-auto">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-indigo-900 mb-2">Entraîneur de CAPTCHA IA</h1>
    <p class="text-gray-600">Validez ou corrigez les prédictions pour améliorer votre modèle</p>
  </div>

  <!-- Statistiques -->
  <div class="grid md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="text-sm text-gray-500 mb-1">Précision</div>
      <div id="stat-accuracy" class="text-3xl font-bold text-indigo-600">0%</div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="text-sm text-gray-500 mb-1">Correctes</div>
      <div id="stat-correct" class="text-3xl font-bold text-green-600">0</div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="text-sm text-gray-500 mb-1">Incorrectes</div>
      <div id="stat-incorrect" class="text-3xl font-bold text-red-600">0</div>
    </div>
  </div>

  <div class="grid md:grid-cols-1 gap-6">
    <!-- SECTION CAPTCHA -->
    <div class="bg-white rounded-lg shadow-lg p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800">Image CAPTCHA</h2>
        <button id="btn-new" class="flex items-center gap-2 px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          Nouveau
        </button>
      </div>

      <div id="captcha-loading" class="hidden flex items-center justify-center h-64 bg-gray-100 rounded-lg">
        <div class="text-gray-400">Chargement...</div>
      </div>

      <div id="captcha-container" class="space-y-6 hidden">
        <div class="bg-gray-100 rounded-lg p-4 flex items-center justify-center" style="min-height:200px">
          <img id="captcha-img" src="" alt="CAPTCHA" class="max-w-full max-h-64 object-contain">
        </div>

        <div class="bg-indigo-50 p-4 rounded-lg">
          <div class="text-sm text-gray-600 mb-1">Prédiction de l'IA :</div>
          <div id="captcha-prediction" class="text-2xl font-bold text-indigo-900"></div>
        </div>

        <div id="feedback-section">
          <div class="flex gap-3" id="feedback-buttons">
            <button id="btn-correct"
              class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
              <i data-lucide="check" class="w-5 h-5"></i> Correct
            </button>

            <button id="btn-incorrect"
              class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
              <i data-lucide="x" class="w-5 h-5"></i> Incorrect
            </button>
          </div>

          <div id="feedback-input" class="hidden mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">Bonne réponse :</label>
            <div class="flex gap-2">
              <input id="correct-answer" type="text"
                class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
              <button id="btn-submit-correction"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">
                <i data-lucide="chevron-right" class="w-5 h-5"></i>
              </button>
            </div>
          </div>

          <div id="feedback-success"
               class="hidden bg-green-50 border border-green-200 text-green-800 p-4 rounded-lg text-center mt-3">
            ✓ Feedback enregistré ! Prochain CAPTCHA...
          </div>

        </div>
      </div>
    </div>
  </div>

</div>

<script>
  lucide.createIcons();

  let stats = { correct: 0, incorrect: 0, total: 0 };
  let historyList = [];
  let currentImage = null;
  let currentPrediction = null;
  let dataset = [];
  let currentIndex = 0;

  const el = {
    loading: document.getElementById("captcha-loading"),
    container: document.getElementById("captcha-container"),
    img: document.getElementById("captcha-img"),
    prediction: document.getElementById("captcha-prediction"),
    feedbackButtons: document.getElementById("feedback-buttons"),
    feedbackInput: document.getElementById("feedback-input"),
    correctAnswer: document.getElementById("correct-answer"),
    feedbackSuccess: document.getElementById("feedback-success"),
    history: document.getElementById("history"),
    statCorrect: document.getElementById("stat-correct"),
    statIncorrect: document.getElementById("stat-incorrect"),
    statAccuracy: document.getElementById("stat-accuracy"),
  };

  async function fetchNewCaptcha() {
    el.loading.classList.remove("hidden");
    el.container.classList.add("hidden");
    el.feedbackInput.classList.add("hidden");
    el.feedbackSuccess.classList.add("hidden");
    el.correctAnswer.value = "";

    if (dataset.length === 0) {
        const res = await fetch("./dataset_result.json");
        dataset = await res.json();
        currentIndex = 0;
    }

    if (currentIndex >= dataset.length) {
        currentIndex = 0;
    }

    const item = dataset[currentIndex];
    currentIndex++;

    currentImage = item.image;
    currentPrediction = item.text;

    el.img.src = currentImage;
    el.prediction.textContent = currentPrediction;

    el.loading.classList.add("hidden");
    el.container.classList.remove("hidden");
    el.feedbackButtons.classList.remove("hidden");
  }

  function updateStats() {
    el.statCorrect.textContent = stats.correct;
    el.statIncorrect.textContent = stats.incorrect;

    const acc = stats.total ? ((stats.correct / stats.total) * 100).toFixed(1) : 0;
    el.statAccuracy.textContent = acc + "%";
  }

  function addHistory(isCorrect, answer) {
    historyList.unshift({
      prediction: currentPrediction,
      correct: answer,
      isCorrect,
      timestamp: new Date().toLocaleTimeString()
    });

    historyList = historyList.slice(0, 10);

    renderHistory();
  }

  function renderHistory() {
    if (historyList.length === 0) {
      el.history.innerHTML = `<p class="text-gray-400 text-center py-8">Aucune prédiction encore</p>`;
      return;
    }

    el.history.innerHTML = historyList
      .map(item => `
        <div class="p-4 rounded-lg border-2 ${item.isCorrect ? "bg-green-50 border-green-200" : "bg-red-50 border-red-200"}">
          <div class="flex justify-between mb-2">
            <span class="font-semibold ${item.isCorrect ? "text-green-700" : "text-red-700"}">
              ${item.isCorrect ? "✓ Correct" : "✗ Incorrect"}
            </span>
            <span class="text-xs text-gray-500">${item.timestamp}</span>
          </div>

          <div class="text-sm text-gray-600">
            Prédiction: <span class="font-mono font-semibold">${item.prediction}</span>
          </div>

          ${!item.isCorrect
            ? `<div class="text-sm text-gray-600">Correct: <span class="font-mono font-semibold">${item.correct}</span></div>`
            : ""
          }
        </div>
      `)
      .join("");
  }

  // --- BUTTON ACTIONS ---

  document.getElementById("btn-new").onclick = fetchNewCaptcha;

  document.getElementById("btn-correct").onclick = () => {
    stats.correct++;
    stats.total++;

    updateStats();
    addHistory(true, currentPrediction);

    el.feedbackButtons.classList.add("hidden");
    el.feedbackSuccess.classList.remove("hidden");

    setTimeout(fetchNewCaptcha, 1000);
  };

  document.getElementById("btn-incorrect").onclick = () => {
    el.feedbackButtons.classList.add("hidden");
    el.feedbackInput.classList.remove("hidden");
  };

  document.getElementById("btn-submit-correction").onclick = () => {
    const correct = el.correctAnswer.value.trim();
    if (!correct) return;

    stats.incorrect++;
    stats.total++;

    updateStats();
    addHistory(false, correct);

    el.feedbackInput.classList.add("hidden");
    el.feedbackSuccess.classList.remove("hidden");

    setTimeout(fetchNewCaptcha, 1000);
  };

  // FIRST LOAD
  fetchNewCaptcha();
</script>

</body>
</html>
